<!DOCTYPE html>
<html lang=en>
	<meta charset="utf-8"/>
	<title>Case Study on Unit Tests</title>
	<meta name="viewport" content="initial-scale=1" />
	<meta name="p:domain_verify" content="73bb9724cf18cc4f5f5d8e8553eeb2ff"/>

	<meta property="og:title" content="Case Study on Unit Tests"/>
	<meta property="og:site_name" content="imdevan"/>
	<meta property="og:description" content="A menu bar app to help you work with your mac, faster."/>
	<meta property="og:url" content="/blog/case-study-on-unit-tests/"/>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400|Roboto+Mono|Dancing+Script" rel="stylesheet">
	<link rel="stylesheet" href="/assets/css/style.css">

	<link rel="shortcut icon" href="/favicon.png"/>

	<body>

<header class="text--code bg--purple">
    <div class="flex flex--verticle-center mw--95-90 m--auto">
        <h3 class="text--light text--shadow">
            ~ <a href="/" >imdevan</a>
            
                / <a href="/blog" >blog</a>
            
            / <a href="/blog/case-study-on-unit-tests/" data="copy">case-study-on-unit-tests</a>
        </h3>
    </div>
</header>


<main role="main" class="bg--white">
  <div class="markdown pt-5 pb-10">
    <!-- Page Title -->
    <h1>Case Study on Unit Tests</h1>
    <time class="text--gray">
        September 12, 2016
        
          â€¢&nbsp;5 minutes
        
    </time>

    <!-- Page content -->
    <div class="pt-5 ">
        <h2 id="code-that-needs-to-be-tested">Code that needs to be&nbsp;tested</h2>

<p>So there we were, trying to create a wrapper for aws to use in our&nbsp;micro-service.
The wrapper would need to take a stream and pass back some kind of&nbsp;confirmation
that reflected what one would expect to get back from&nbsp;aws.</p>

<p>This is the code we came up&nbsp;with</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">helper</span><span class="p">.</span><span class="nx">uploadStream</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Bucket</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span>
            <span class="s2">"s3-helper.uploadStream: Bucket param was not provided"</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span>
            <span class="s2">"s3-helper.uploadStream: Key param was not provided"</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span>
            <span class="s2">"s3-helper.uploadStream: Body param was not provided"</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="err">`</span><span class="nx">Uploading</span> <span class="nx">$</span><span class="p">{</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Key</span><span class="p">}</span> <span class="nx">to</span> <span class="nx">s3</span><span class="err">`</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">s3obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">S3</span><span class="p">({</span>
        <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">Bucket</span><span class="p">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Bucket</span><span class="p">,</span>
            <span class="na">Key</span><span class="p">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Key</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="nx">dd</span>
    <span class="nx">s3obj</span><span class="p">.</span><span class="nx">upload</span><span class="p">({</span><span class="na">Body</span><span class="p">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Body</span><span class="p">}).</span><span class="nx">send</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure>

<p><code>helper.uploadStream</code> takes an object <code>opts</code> and a&nbsp;<code>callback</code>.</p>

<p>This is what opts looks like based on the properties that are called&nbsp;throughout
the&nbsp;functtion.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">Bucket</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">obj</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="na">Key</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">obj</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="na">Body</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">stream</span><span class="o">&gt;</span>
<span class="p">}</span></code></pre></figure>

<p><code>opts.Bucket</code> and <code>opts.Key</code> are directly applied to the <code>aws.S3</code>&nbsp;module.</p>

<p><code>opts.Body</code> is applied when <code>s3obj.upload</code> is&nbsp;called.</p>

<p><code>aws.S3</code> creates an object which is than passed a Body which is passed&nbsp;as
property of&nbsp;opts.</p>

<p>We know from looking at the <a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/guide/node-examples.html">aws&nbsp;documentation</a>
that <code>s3obj.upload</code> will return an object that contains the Bucket and Key in&nbsp;a
successful run, and it will return an error&nbsp;otherwise.</p>

<p class="s">From the above code we derive that there are 3 possible cases that needed to&nbsp;be
tested.</p>

<h2 id="test-cases">Test&nbsp;cases</h2>

<h3 id="called-with-bad-params">1. Called with bad&nbsp;params</h3>

<p>The test case for this is easy enough. We check for the error returned to&nbsp;match
what we put the error to be returned&nbsp;as.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">it</span><span class="p">(</span><span class="s2">"can catch missing bucket param"</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">s3Helper</span><span class="p">.</span><span class="nx">uploadStream</span><span class="p">({},</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">exist</span><span class="p">;</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span>
            <span class="s2">"s3-helper.uploadStream: Bucket param was not provided"</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="s2">"can catch missing key param"</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">s3Helper</span><span class="p">.</span><span class="nx">uploadStream</span><span class="p">({</span> <span class="na">Bucket</span><span class="p">:</span> <span class="s2">"test-bucket"</span> <span class="p">},</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">exist</span><span class="p">;</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span>
            <span class="s2">"s3-helper.uploadStream: Key param was not provided"</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="s2">"can catch missing body param"</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">s3Helper</span><span class="p">.</span><span class="nx">uploadStream</span><span class="p">({</span> <span class="na">Bucket</span><span class="p">:</span> <span class="s2">"test-bucket"</span><span class="p">,</span> <span class="na">Key</span><span class="p">:</span> <span class="s2">"test-key"</span> <span class="p">},</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">exist</span><span class="p">;</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span>
            <span class="s2">"s3-helper.uploadStream: Body param was not provided"</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></figure>

<h3 class="st" id="down-stream-errors">2. Down Stream&nbsp;Errors</h3>

<p>To do this we use a design pattern called <code>breaker</code> (or at least thatâ€™s what&nbsp;Iâ€™m
calling it). Basically, we have a mockAws object that has a property called&nbsp;<code>breakers</code>.</p>

<p>If we set the breaker for <code>upload</code> to true, we should get an error from&nbsp;mockAws,
which <code>s3Helper</code> is digesting instead of <code>aws</code>, because of another&nbsp;design
pattern,&nbsp;<code>proxy-require</code>.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">it</span><span class="p">(</span><span class="s2">"can handle an error thrown by aws"</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Define opts object</span>
    <span class="kr">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">through2</span><span class="p">(),</span>
        <span class="nx">uploadOpts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">Bucket</span><span class="p">:</span> <span class="s2">"test-bucket"</span><span class="p">,</span>
            <span class="na">Key</span><span class="p">:</span> <span class="s2">"test-key"</span><span class="p">,</span>
            <span class="na">Body</span><span class="p">:</span> <span class="nx">stream</span>
        <span class="p">};</span>

    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">"dummy upload text"</span><span class="p">);</span>
        <span class="nx">stream</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="c1">// Set breaker error</span>
    <span class="nx">mockAWS</span><span class="p">.</span><span class="nx">breakers</span><span class="p">.</span><span class="nx">upload</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="c1">// Call s3Helper</span>
    <span class="nx">s3Helper</span><span class="p">.</span><span class="nx">uploadStream</span><span class="p">(</span><span class="nx">uploadOpts</span><span class="p">,</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">"mockS3: upload breaker error"</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></figure>

<h3 class="st" id="everything-works-">3. Everything Works!&nbsp;ðŸ˜€</h3>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">it</span><span class="p">(</span><span class="s2">"can successfully upload stream"</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Define opts object</span>
    <span class="kr">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">through2</span><span class="p">(),</span>
        <span class="nx">uploadOpts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">Bucket</span><span class="p">:</span> <span class="s2">"test-bucket"</span><span class="p">,</span>
            <span class="na">Key</span><span class="p">:</span> <span class="s2">"test-key"</span><span class="p">,</span>
            <span class="na">Body</span><span class="p">:</span> <span class="nx">stream</span>
        <span class="p">};</span>

    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">"dummy upload text"</span><span class="p">);</span>
        <span class="nx">stream</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="nx">s3Helper</span><span class="p">.</span><span class="nx">uploadStream</span><span class="p">(</span><span class="nx">uploadOpts</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">mockLogger</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span>
            <span class="err">`</span><span class="nx">Uploading</span> <span class="nx">$</span><span class="p">{</span><span class="nx">uploadOpts</span><span class="p">.</span><span class="nx">Key</span><span class="p">}</span> <span class="nx">to</span> <span class="nx">s3</span><span class="err">`</span><span class="p">);</span>

        <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">equal</span><span class="p">({</span>
            <span class="na">Bucket</span><span class="p">:</span> <span class="nx">uploadOpts</span><span class="p">.</span><span class="nx">Bucket</span><span class="p">,</span>
            <span class="na">Key</span><span class="p">:</span> <span class="nx">uploadOpts</span><span class="p">.</span><span class="nx">Key</span>
        <span class="p">});</span>

        <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></figure>

<h2 class="st" id="in-conclusion">In&nbsp;Conclusion</h2>

<p>Thatâ€™s the minimal thought process that should probably go into creating&nbsp;unit
tests for&nbsp;node.</p>

<ul>
  <li>Would could go wrong that we can&nbsp;handle?</li>
  <li>What could cause this code to break that we canâ€™t&nbsp;handle?</li>
  <li>What happens when everything goes&nbsp;well?</li>
</ul>

<p>If you have any cool tips to share on unit tests, you should definitely tweet&nbsp;them
at&nbsp;me~!</p>

<p class="text--center text--lg">ðŸ‘‡</p>

    </div>

    <!-- Author link -->
    <div class="text--center st">
        by <a href="https://twitter.com/devanIpsum">Devan</a>
    </div>
    <!-- Twitter share ðŸ˜‰ -->
    <div class="text--center mt-sm">
        <a href="https://twitter.com/share" class="twitter-share-button" data-size="large" data-via="devanIpsum" data-show-count="false">Tweet</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
  </div>
</main>

    <!-- Footer -->
	<footer class="bg--dark text--light shadow--inverted-lg" role="contentinfo">

		<!-- Featured content -->
		<div class="flex flex--md-row mw--95-90 m--auto pt-5">
			
				<a href="http://hackdfw.com" class="flex__box-1 flex__box--gutter p-1 text--light  trans-all--fast-in-out">
				        <h3>HackDFW</h3>
				        I'm currently working to bring a really awesome hackathon to Dallas.
                </a>
			
				<a href="/hire-me" class="flex__box-1 flex__box--gutter p-1 text--light  trans-all--fast-in-out">
				        <h3>Hire Me</h3>
				        I create digital experiences that have form and purpose.
                </a>
			
				<a href="/blog/" class="flex__box-1 flex__box--gutter p-1 text--light  trans-all--fast-in-out">
				        <h3>Latest Post</h3>
				        Looking for something to read?
                </a>
			
		</div>

		<!-- Email form -->
		<div class="mw--95-90 m--auto pt-5 text--center">
			<a class="text--light" href="mailto:huapayadevan@gmail.com">huapayadevan@gmail.com</a>
		</div>

		<!-- Salutation -->
		<div class="mw--95-90 m--auto py-5">
			Thanks for visiting my site, <br>
			<a target="_blank" class="text--light" href="http://twitter.com/devanipsum">
				Devan
			</a>
		</div>
	</footer>
</body>

</html>

